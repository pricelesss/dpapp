<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta charset="UTF-8">
<title>DPApp JSBridge Demo</title>
<style>
  body{
    background-color: #000;
    overflow: scroll;
  }
  .btn{
    display: block;
    background-color: #f63;
    color:#fff;
    text-decoration: none;
    text-align: center;
    font-size: 16px;
    padding: 10px 5px;
    margin: 10px 5px;
    border-radius: 5px
  }
  .log-panel{
    width: 100%;
    position: fixed;
    top: 0px;
    left: 0px;
    background: #6CD786;
    color: #fff;
    z-index: 1;
  }
  .log-panel .content{
    overflow: hidden;
    -webkit-transition: height .2s linear;
  }
  .log-panel p{
    padding: 10px;
    margin: 0;
  }

  .shadow-content{
    position: absolute;
    visibility: hidden;
    width: 100%;
  }

  .shadow-content p{
    padding: 10px;
    margin: 0
  }

</style>
</head>

<body>

  <a class="btn" href="javascript:location.reload()">刷新</a>
  <a class="btn" id="getUA" href="javascript:;">获取客户端环境信息</a>
  <a class="btn" id="callMulti" href="javascript:;">连续方法调用</a>
  <a class="btn" id="getCityId" href="javascript:;">获取城市信息</a>
  <a class="btn" id="getUserInfo" href="javascript:;">获取用户信息</a>
  <a class="btn" id="getLocation" href="javascript:;">获取地理位置</a>
  <a class="btn" id="getNetworkType" href="javascript:;">获取网络状态</a>
  <a class="btn" id="getContactList" href="javascript:;">获取联系人列表</a>
  <!-- <a class="btn" id="getCX" href="javascript:;">获取诚信数据</a> -->
  <a class="btn" id="ajax" href="javascript:;">Ajax(.bin)</a>
  <a class="btn" id="ajax-json" href="javascript:;">Ajax(.json)</a>
  <a class="btn" id="ga" href="javascript:;">ga</a>

  <a class="btn" id="uploadImage" href="javascript:;">上传图片</a>
  <a class="btn" id="downloadImage" href="javascript:;">下载图片</a>
  <a class="btn" id="closeWindow" href="javascript:;">关闭webview</a>
  <a class="btn" id="pay" href="javascript:;">第三方支付</a>
  <a class="btn" id="share" href="javascript:;">分享</a>
  <a class="btn" id="sendSMS" href="javascript:;">发送短信</a>


  <a class="btn" id="subscribe" href="javascript:;">订阅消息</a>
  <a class="btn" id="unsubscribe" href="javascript:;">取消订阅</a>
  <a class="btn" id="publish" href="javascript:;">广播消息</a>


  <a class="btn" id="setTitle" href="javascript:;">设置标题</a>
  <a class="btn" id="setRLButton" href="javascript:;">设置RL按钮</a>
  <a class="btn" id="setRRButton" href="javascript:;">设置RR按钮</a>
  <a class="btn" id="setSearchButton" href="javascript:;">设置RR搜索按钮</a>

  <a class="btn" id="login" href="javascript:;">登录</a>

  <!-- <img src="./sc.png" alt="" style="position:fixed;bottom:0;width:100%;z-index:10;opacity:0.5;point-event:none"> -->
  <div id="loginContainer"></div>

<script src="./dest/standalone.js"></script>
<script>

  var success = function(ret){
    console.log(JSON.stringify(ret));
  };
  var fail = function(ret){
    console.log(ret);
  }
  var defaultConfig = {
    success: success,
    fail: fail
  };
  var args = {
    getUserInfo: defaultConfig,
    getLocation: defaultConfig,
    getNetworkType: defaultConfig,
    getContactList: defaultConfig,
    getCityId: defaultConfig,
    // getCX: defaultConfig,
    ajax: {
      url: "http://m.api.dianping.com/indextabicon.bin?cityid=1&version=7.0.1",
      method: "get",
      success: success,
      fail: fail
    },
    ga: {
      success: success,
      fail: fail
    },
    uploadImage: {
      uploadUrl: "", // 上传图片调用的mapi接口的url
      compressFactor: 1024, // 可选，上传图片压缩到多少尺寸以下，单位为K
      maxNum: 5, // 需填写，默认为0
      extra: {}, // 业务参数
      success: success,
      fail: fail
    },
    downloadImage: {
      imageUrl: "http://www.dpfile.com/toevent/img/16d05c85a71b135edc39d197273746d6.png",
      success: success,
      fail: fail
    },
    closeWindow: defaultConfig,
    // pay: {
    //  success: success
    // },
    share: {
      title:"分享标题",
      desc:"分享描述",
      content: "覆盖内容",
      feed: [DPApp.Share.WECHAT_FRIENDS, DPApp.Share.WECHAT_TIMELINE, DPApp.Share.WEIBO],
      image:"http://www.dpfile.com/toevent/img/16d05c85a71b135edc39d197273746d6.png",
      url:"http://m.dianping.com",
      success: success,
      fail: fail
    },
    sendSMS: {
      recipients: 13987654321,
      content: "短信内容",
      success: success,
      fail: fail
    },
    subscribe: {
      action: "message",
      success: function(){
        DPApp._log("消息绑定");
      },
      handle: function(){
        DPApp._log('消息触发');
      },
      fail: fail
    },
    unsubscribe: {
      action: "message",
      fail: fail
    },
    publish: {
      action: "message",
      fail: fail
    },
    setTitle: {
      title: "新标题",
      success: success
    },
    setRLButton: {
      text: "默认",
      fail: fail
    },
    setRRButton: {
      text: "分享",
      icon: "H5_Share",
      success: success,
      fail: fail,
      handle: function(){
        DPApp.share({
          title: document.title,
          desc: document.title,
          image: 'http://i2.s1.dpfile.com/pc/mc/b99de9c6e32d86ba2866380092f1f7f2(353c221)/thumb.jpg',
          url: location.href,
          success: function(){
            DPApp._log('分享成功');
          }
        });
      }
    }
  }

  DPApp.config({
    debug: false
  });

  $('login').onclick = function(){
    DPApp.login({
      success: success,
      fail: fail
    });
  }

  function $(id){return document.getElementById(id);}

  for(var id in args){
    (function(id){
      $(id).onclick = function(){
        Efte[id](args[id]);
      };

      function series(steps, callback){
        var count = steps.length;
        var results = [];
        function done(err, result){
          if(err){
            return callback(err);
          }else{
            results.push(result);
            steps.count--;
            steps.shift();
            if(steps.length){
              steps[0](done);
            }else{
              callback(null, results);
            }
          }
        }
        steps[0](done);
      }

      function getBaseInfo(callback){
        var info = {};
        series([
          function(done){
            DPApp.getUserInfo({
              success: function(user){
                done(null, user);
              },
              fail: function(){
                done("fail get user");
              }
            });
          },
          function(done){
            DPApp.getCityId({
              success: function(result){
                done(null, result.cityId);
              },
              fail: function(){
                done("fail get cityId");
              }
            });
          }
        ], function(err, result){
          if(err){return callback(err);}
          callback(null, {
            user: result[0],
            cityId: result[1]
          });
        });
      }

      function getTuangouDeal(data, callback){
        DPApp.ajax({
          url: 'http://app.t.dianping.com/dealgn.bin',
          data: data,
          keys: [
            "Deal",
            "ID",
            "Price",
            "DealSelectList"
          ],
          success: function(deal) {
            callback(null , deal);
          },
          fail: function(){
            callback("fail get tuangou deal");
          }
        });
      }

      function loopQuery(paymentinfo, callback){

        var count = paymentinfo.RetryCount;

        function takeATry(){
            DPApp.ajax({
                url:"http://api.p.dianping.com/getsubmitorderresult.pay",
                data:{
                    advanceorderid: paymentinfo.AdvanceOrderId
                },
                keys:["OrderId","Status","ErrorMsg"],
                success: function(data){
                    if(data.Status == 1){
                        callback(null, {
                            ID: data.OrderId
                        });
                    }else if(data.Status == 0){
                        callback(data.ErrorMsg);
                    }else{
                        count--;
                        if(count == 0){
                            callback("fail loop query");
                        }else{
                            setTimeout(takeATry, paymentinfo.IntervalTime);
                        }
                    }
                }
            });
        }
        takeATry();
      }

      function createOrder(data, callback){
        DPApp.ajax({
          url: 'http://app.t.dianping.com/createordergn.bin',
          data: data,
          keys: [
            "PaymentInfo",
            "AdvanceOrderId",
            "RetryCount",
            "IntervalTime",
            "DiscountList",
            "Balance",
            "PaymentType",
            "ID",
            "Flag",
            "AlertMsg"
            ],
          success: function (paymentinfo) {
            if(paymentinfo.ID == 0){
              // 轮训
              loopQuery(paymentinfo, callback);
            }else{
              callback(null, paymentinfo);
            }
          },
          fail: function (error) {
            callback("fail create order");
          }
        });
      }

      function payOrder(data, callback){
        DPApp.ajax({
          url: 'http://api.p.dianping.com/payorder.pay',
          data: data,
          keys: ["Content"],
          success: function (paymsg) {
            callback(null, paymsg);
          },
          fail: function(fail){
            callback("fail payorder");
          }
        });
      }

      function getPaymentTool(payType){
        var PAY_TYPE_MINIALIPAY = 1;
        var PAY_TYPE_WEIXINPAY = 7;
        var PAYMENTTOOL_ALIPAY = "5:1:null#219#0";
        var PAYMENTTOOL_WEIXINPAY = "11:1:null#217#0";
        if (payType == PAY_TYPE_WEIXINPAY) {
          paymentTool = PAYMENTTOOL_WEIXINPAY;
        }else{
          paymentTool = PAYMENTTOOL_ALIPAY;
        }
        return paymentTool;
      }

      $('pay').onclick = function(){
        var payType = 7;
        var info, deal, order;
        var paymsg;
        series([
          function(done){
            getBaseInfo(function(err, result){
              if(err){return done(err);}
              info = result;
              done(null);
            });
          },
          function(done){
            getTuangouDeal({
              id: 6191069,
              cityid: info.cityId,
              token: info.user.token
            },function(err, result){
              if(err){return done(err);}
              deal = result;
              done(null);
            });
          },
          function(done){
            createOrder({
              groupid: deal.ID,
              dealid: deal.DealSelectList[0].ID,
              token: info.user.token,
              cityid: info.cityId,
              count: 1,
              paymentamount: deal.Price,
              cx: info.cx
            }, function(err, result){
              if(err){return done(err);}
              order = result;
              done(null);
            });
          },
          function(done){
            payOrder({
              token: info.user.token,
              orderid: order.ID,
              paymenttool: getPaymentTool(payType),
              cx: info.cx
            }, function(err, result){
              if(err){return done(err);}
              paymsg = result;
              done(null);
            });
          }
        ], function(err){
          if(err){
            return DPApp._log(err);
          }else{
            DPApp.pay({
              paytype: payType,
              paycontent: paymsg.Content,
              success: function(data) {
                DPApp._log(JSON.stringify(data));
              },
              fail: function(data) {
                DPApp._log(JSON.stringify(data));
              }
            });
          }
        });
      }

      $('uploadImage').onclick = function(){

        var params = {
          sign: data.picSignature,
          nut: data.picToken
        };

        window.DPApp.uploadImage({
          uploadUrl: data.mapiUrl,
          maxNum: 9,
          extra: {
            uploadurl: data.groupPicUploadUrl,
            businessType: 'community',
            params: JSON.stringify(params)
          },
          fail: fail
        }, uploadImageCallback);

      }

      $('ajax-json').onclick = function(){
        DPApp.ajax({
          url:"http://app.t.51ping.com/ajax/tuan/dealgn.json",
          data:{
            cityid:1,
            id:10713251
          },
          success: function(result){
            DPApp._log(JSON.stringify(result));
          },
          fail: function(){
            DPApp._log("调用失败");
          }
        });
      };

      $('getUA').onclick = function(){
        DPApp._log(JSON.stringify(DPApp.getUA()));
      };

      $('setSearchButton').onclick = function(){
        DPApp.setRRButton({
          icon:"H5_Search",
          fail: fail,
          handle: function(){
            DPApp.openScheme({
                url: "dianping://websearch",
                extra: {
                    "hotsuggesturl":"http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000",
                    "keywordurl":"http://m.api.dianping.com/advancedsuggest.bin?cityid=1&mylat=31.215870&mylng=121.419100&myacc=0.000000"
                }
            });
          }
        });
      };



      document.getElementById('callMulti').onclick = function(){
        DPApp.getUserInfo({success:success});
        DPApp.getLocation({success:success});
        DPApp.getNetworkType({success:success});
      }
    })(id);
  }


    DPApp.subscribe({
      action: 'foreground',
      handle: function(){
        console.log('happened!');
      }
    });


    DPApp.subscribe({
      action: 'foreground',
      handle: function(){
        console.log('happened!2');
      }
    });

  window.onerror = function(a,b){
    // DPApp._log(a);
    // DPApp._log(b);
  }



  DPApp.did_handle_callback = DPApp.dequeue;

</script>
</body>

</html>
